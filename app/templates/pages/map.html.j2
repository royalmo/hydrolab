{% extends 'base/map_base.html.j2' %}
{% block body %}

<div id="map" class="border border-black absolute h-full w-full"></div>

<script>
    {%if center %}
    var map = L.map('map').setView({{ center }}, 15);
    {% else %}
    var map = L.map('map').setView([41.38, 2.16], 9);
    {% endif %}
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var bounds = new L.LatLngBounds();
    var sensorsAdded = false;

    var greenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });


    var redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var errorIcon = new L.Icon({
        iconUrl: '{{ url_for("static", filename = "images/triangle-exclamation-solid.svg") }}', // Path to your SVG file
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [30, 50],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    let icon = null

    {% for eachsensor in sensors %}

    {% if eachsensor.location and eachsensor.location.latitude is not none and eachsensor.location.longitude is not none %}
    var sensorLocation = new L.LatLng({{ eachsensor.location.latitude }}, {{ eachsensor.location.longitude }});
    bounds.extend(sensorLocation);
    sensorsAdded = true;

    {% set has_errors = eachsensor.parsed_errors() %}

    {% set number_of_errors = has_errors | length > 0 %}

    {% set last_uplink = eachsensor.get_last_uplink() %}
    var sensorPopupContent = `
                    <h2 class="mb-2"><b>{{ eachsensor.name }}</b></h2>
                    <b>Humidity:</b> {{ last_uplink.humidity }}%<br>
                    <b>Temperature:</b> {{ last_uplink.temperature }} Â°C<br>
                    <b>Battery: </b>{{ last_uplink.battery }}%<br>
                    <b>Last Watered: </b>{{ eachsensor.last_watered_at }}<br>
                    <div class="flex flex-row justify-between my-2">
                        <div class="bg-blue-200 text-white font-bold py-1 px-4 rounded cursor-pointer">
                            <a href="{{ url_for('.sensors.info', id=eachsensor.id) }}" target="_blank">More Info</a>
                        </div>
                        {% if number_of_errors %}
                        <a href="{{ url_for('.sensors.info', id=eachsensor.id) + '#errors' }}" target="_blank" class="ml-2">
                            <img src='{{ url_for("static", filename = "images/triangle-exclamation-solid.svg") }}' alt='Warning' class="w-5 h-5" />
                        </a>
                        {% endif %}
                    </div>
                `;

    {% if number_of_errors %}
    icon = errorIcon;
    {% elif eachsensor.status %}
    icon = greenIcon;
    {% else %}
    icon = redIcon;
    {% endif %}

    L.marker(sensorLocation, { icon: icon })
        .addTo(map)
        .bindPopup(sensorPopupContent);

    {% endif %}
    {% endfor %}

    // Adjust the map view to include all sensors
    if (sensorsAdded) {
        map.fitBounds(bounds, { padding: [50, 50] });
    } else {
        // Fallback to default view if no sensors are present
        map.setView([41.38, 2.16], 9);
    }

</script>

{% endblock %}